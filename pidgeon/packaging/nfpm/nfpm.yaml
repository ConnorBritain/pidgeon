# nFPM configuration for Pidgeon CLI
# Generates .deb, .rpm, and .apk packages

name: pidgeon
arch: "${ARCH}"
platform: linux
version: "${VERSION}"
version_schema: semver
section: utils
priority: optional
maintainer: Pidgeon Health <support@pidgeon.health>
description: |
  Healthcare message testing and validation CLI

  Pidgeon CLI is a comprehensive healthcare interoperability testing platform
  that supports HL7, FHIR, and NCPDP standards. It provides message generation,
  validation, de-identification, and vendor pattern analysis capabilities.

  Key features:
  - Multi-standard message generation (HL7, FHIR, NCPDP)
  - Advanced validation with vendor pattern detection
  - On-premises PHI de-identification
  - Interactive workflow wizard
  - AI-powered message analysis and comparison
  - Cross-platform shell completion support

vendor: Pidgeon Health, Inc.
homepage: https://pidgeon.health
license: MPL-2.0
url: https://github.com/PidgeonHealth/pidgeon

depends:
  # No runtime dependencies - self-contained binary

suggests:
  - bash-completion
  - zsh
  - fish

contents:
  # Main binary
  - src: "dist/pidgeon-linux-${ARCH}/pidgeon"
    dst: "/usr/bin/pidgeon"
    file_info:
      mode: 0755
      owner: root
      group: root

  # Shell completions
  - src: "dist/pidgeon-linux-${ARCH}/completions/pidgeon.bash"
    dst: "/usr/share/bash-completion/completions/pidgeon"
    file_info:
      mode: 0644
      owner: root
      group: root

  - src: "dist/pidgeon-linux-${ARCH}/completions/_pidgeon"
    dst: "/usr/share/zsh/vendor-completions/_pidgeon"
    file_info:
      mode: 0644
      owner: root
      group: root

  - src: "dist/pidgeon-linux-${ARCH}/completions/pidgeon.fish"
    dst: "/usr/share/fish/vendor_completions.d/pidgeon.fish"
    file_info:
      mode: 0644
      owner: root
      group: root

  # Install channel marker
  - src: "packaging/nfpm/install-marker-apt.json"
    dst: "/usr/share/pidgeon/install.json"
    file_info:
      mode: 0644
      owner: root
      group: root

  # Documentation
  - src: "README.md"
    dst: "/usr/share/doc/pidgeon/README.md"
    file_info:
      mode: 0644
      owner: root
      group: root

  - src: "LICENSE"
    dst: "/usr/share/doc/pidgeon/LICENSE"
    file_info:
      mode: 0644
      owner: root
      group: root

scripts:
  preinstall: |
    #!/bin/bash
    # Pre-installation script
    echo "Installing Pidgeon CLI..."

  postinstall: |
    #!/bin/bash
    # Post-installation script
    echo "Pidgeon CLI installed successfully!"
    echo ""
    echo "Quick start:"
    echo "  pidgeon --version"
    echo "  pidgeon --help"
    echo "  pidgeon generate message --type ADT^A01"
    echo ""
    echo "Documentation: https://docs.pidgeon.health"

    # Enable shell completions hint
    if [ -f /usr/share/bash-completion/completions/pidgeon ]; then
      echo ""
      echo "Bash completion is available. Restart your shell or run:"
      echo "  source /usr/share/bash-completion/completions/pidgeon"
    fi

  preremove: |
    #!/bin/bash
    # Pre-removal script
    echo "Removing Pidgeon CLI..."

  postremove: |
    #!/bin/bash
    # Post-removal script
    echo "Pidgeon CLI removed."
    echo "Configuration files in ~/.pidgeon are preserved."

# Package formats to generate
targets:
  - deb
  - rpm
  - apk

# DEB-specific configuration
deb:
  fields:
    Bugs: https://github.com/PidgeonHealth/pidgeon/issues
    Origin: Pidgeon Health, Inc.

  compression: gzip

  # Package relationships
  recommends:
    - bash-completion

  suggests:
    - zsh
    - fish

# RPM-specific configuration
rpm:
  group: Applications/System

  compression: gzip

  # Package relationships
  suggests:
    - bash-completion
    - zsh
    - fish

# APK-specific configuration (Alpine Linux)
apk:
  # Package relationships
  recommends:
    - bash-completion

# Overrides for different architectures
overrides:
  deb:
    arch_to_deb:
      amd64: amd64
      arm64: arm64

  rpm:
    arch_to_rpm:
      amd64: x86_64
      arm64: aarch64

  apk:
    arch_to_apk:
      amd64: x86_64
      arm64: aarch64