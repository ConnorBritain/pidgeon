{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "HL7 Segment Definition Schema",
  "description": "JSON schema for HL7 segment definitions with cardinality, usage, and vendor intelligence",
  "type": "object",
  "required": ["segment", "name", "description", "standard", "version", "usage", "fields"],
  "properties": {
    "segment": {
      "type": "string",
      "description": "Three-letter segment identifier (e.g., PID, MSH, OBR)",
      "pattern": "^[A-Z]{2,3}$"
    },
    "name": {
      "type": "string",
      "description": "Human-readable segment name"
    },
    "description": {
      "type": "string",
      "description": "Detailed description of the segment's purpose and usage"
    },
    "standard": {
      "type": "string",
      "description": "Standard identifier (e.g., hl7v23, hl7v24)",
      "enum": ["hl7v21", "hl7v22", "hl7v23", "hl7v24", "hl7v25", "hl7v26", "hl7v27", "hl7v28", "hl7v29"]
    },
    "version": {
      "type": "string",
      "description": "Version of the standard (e.g., 2.3, 2.4)"
    },
    "usage": {
      "type": "string",
      "description": "Segment usage: R=Required, O=Optional, C=Conditional, X=Not used",
      "enum": ["R", "O", "C", "X"]
    },
    "cardinality": {
      "type": "object",
      "description": "Cardinality rules for this segment in messages",
      "properties": {
        "min": {
          "type": "integer",
          "description": "Minimum occurrences (0 for optional)",
          "minimum": 0
        },
        "max": {
          "type": ["integer", "string"],
          "description": "Maximum occurrences (number or 'unbounded')"
        }
      }
    },
    "messageTypes": {
      "type": "array",
      "description": "Message types that commonly use this segment",
      "items": {
        "type": "string",
        "description": "Message type (e.g., ADT^A01, ORU^R01)"
      }
    },
    "fields": {
      "type": "object",
      "description": "Field definitions for this segment",
      "patternProperties": {
        "^[A-Z]{2,3}\\.[0-9]+$": {
          "$ref": "#/definitions/field"
        }
      },
      "additionalProperties": false
    },
    "vendorVariations": {
      "type": "object",
      "description": "Vendor-specific variations and implementation notes",
      "patternProperties": {
        "^[a-z]+$": {
          "$ref": "#/definitions/vendorNote"
        }
      },
      "additionalProperties": false
    },
    "crossReferences": {
      "type": "object",
      "description": "Cross-references to equivalent elements in other standards",
      "patternProperties": {
        "^(fhir-r[4-5]|ncpdp|x12)$": {
          "type": "object",
          "patternProperties": {
            "^[A-Z]{2,3}\\.[0-9]+(\\.[0-9]+)*$": {
              "type": "string",
              "description": "Equivalent path in target standard"
            }
          }
        }
      }
    },
    "examples": {
      "type": "array",
      "description": "Complete segment examples",
      "items": {
        "type": "string",
        "description": "Example segment content"
      }
    },
    "notes": {
      "type": "array",
      "description": "Additional implementation notes and guidance",
      "items": {
        "type": "string"
      }
    }
  },
  "definitions": {
    "field": {
      "type": "object",
      "required": ["name", "dataType", "usage"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable field name"
        },
        "description": {
          "type": "string",
          "description": "Detailed field description"
        },
        "dataType": {
          "type": "string",
          "description": "HL7 data type (ST, CX, CE, etc.)"
        },
        "usage": {
          "type": "string",
          "description": "Field usage: R=Required, O=Optional, C=Conditional, X=Not used",
          "enum": ["R", "O", "C", "X"]
        },
        "cardinality": {
          "type": "object",
          "description": "Field cardinality rules",
          "properties": {
            "min": {
              "type": "integer",
              "minimum": 0
            },
            "max": {
              "type": ["integer", "string"]
            }
          }
        },
        "maxLength": {
          "type": "integer",
          "description": "Maximum field length",
          "minimum": 1
        },
        "minLength": {
          "type": "integer", 
          "description": "Minimum field length",
          "minimum": 0
        },
        "table": {
          "type": "string",
          "description": "HL7 table reference for coded values (e.g., 0001, 0203)"
        },
        "examples": {
          "type": "array",
          "description": "Example values for this field",
          "items": {
            "type": "string"
          }
        },
        "validValues": {
          "type": "array",
          "description": "Valid coded values for this field",
          "items": {
            "$ref": "#/definitions/validValue"
          }
        },
        "components": {
          "type": "object",
          "description": "Component field definitions (for complex data types)",
          "patternProperties": {
            "^[A-Z]{2,3}\\.[0-9]+\\.[0-9]+$": {
              "$ref": "#/definitions/field"
            }
          }
        },
        "conditionalRules": {
          "type": "array",
          "description": "Rules for conditional usage",
          "items": {
            "type": "object",
            "properties": {
              "condition": {
                "type": "string",
                "description": "Condition expression"
              },
              "description": {
                "type": "string",
                "description": "Human-readable condition description"
              }
            }
          }
        }
      }
    },
    "validValue": {
      "type": "object",
      "required": ["code", "description"],
      "properties": {
        "code": {
          "type": "string",
          "description": "The coded value"
        },
        "description": {
          "type": "string",
          "description": "Description of the coded value"
        },
        "isDeprecated": {
          "type": "boolean",
          "description": "Whether this value is deprecated",
          "default": false
        },
        "addedInVersion": {
          "type": "string",
          "description": "Version when this value was added"
        },
        "deprecatedInVersion": {
          "type": "string",
          "description": "Version when this value was deprecated"
        }
      }
    },
    "vendorNote": {
      "type": "object",
      "required": ["vendor"],
      "properties": {
        "vendor": {
          "type": "string",
          "description": "Vendor name (epic, cerner, allscripts, etc.)"
        },
        "notes": {
          "type": "array",
          "description": "Vendor-specific implementation notes",
          "items": {
            "type": "string"
          }
        },
        "examples": {
          "type": "object",
          "description": "Vendor-specific examples by field path",
          "patternProperties": {
            "^[A-Z]{2,3}\\.[0-9]+(\\.[0-9]+)*$": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "requiredFields": {
          "type": "array",
          "description": "Fields that are required by this vendor (beyond standard)",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]{2,3}\\.[0-9]+(\\.[0-9]+)*$"
          }
        },
        "optionalFields": {
          "type": "array", 
          "description": "Fields that are optional for this vendor (even if required in standard)",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]{2,3}\\.[0-9]+(\\.[0-9]+)*$"
          }
        },
        "customValues": {
          "type": "object",
          "description": "Vendor-specific valid values by field",
          "patternProperties": {
            "^[A-Z]{2,3}\\.[0-9]+(\\.[0-9]+)*$": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/validValue"
              }
            }
          }
        }
      }
    }
  }
}