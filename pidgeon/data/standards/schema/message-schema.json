{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "HL7 Message Structure Schema",
  "description": "JSON schema for HL7 message type definitions with segment ordering, cardinality, and generation rules",
  "type": "object",
  "required": ["messageType", "triggerEvent", "name", "description", "standard", "version", "structure"],
  "properties": {
    "messageType": {
      "type": "string",
      "description": "Message type code (ADT, ORU, RDE, etc.)",
      "pattern": "^[A-Z]{2,4}$"
    },
    "triggerEvent": {
      "type": "string", 
      "description": "Trigger event code (A01, R01, O11, etc.)",
      "pattern": "^[A-Z][0-9]{2}$"
    },
    "name": {
      "type": "string",
      "description": "Human-readable message name"
    },
    "description": {
      "type": "string",
      "description": "Detailed description of the message purpose and use cases"
    },
    "standard": {
      "type": "string",
      "description": "Standard identifier",
      "enum": ["hl7v21", "hl7v22", "hl7v23", "hl7v24", "hl7v25", "hl7v26", "hl7v27", "hl7v28", "hl7v29"]
    },
    "version": {
      "type": "string",
      "description": "Version of the standard"
    },
    "category": {
      "type": "string",
      "description": "Message category for organization",
      "enum": ["Patient Administration", "Order Entry", "Query", "Financial Management", "Observation Reporting", "Master Files", "Medical Records/Information Management", "Scheduling", "Patient Referral", "Patient Care", "Laboratory Automation", "Application Management", "Personnel Management"]
    },
    "structure": {
      "type": "array",
      "description": "Ordered list of segments/groups that make up this message",
      "items": {
        "$ref": "#/definitions/messageElement"
      },
      "minItems": 1
    },
    "useCases": {
      "type": "array",
      "description": "Common use cases for this message type",
      "items": {
        "type": "string"
      }
    },
    "generationGuidance": {
      "type": "object",
      "description": "Guidance for generating realistic instances of this message",
      "properties": {
        "typical": {
          "type": "object",
          "description": "Typical field population patterns",
          "additionalProperties": true
        },
        "minimal": {
          "type": "object", 
          "description": "Minimal required fields for valid message",
          "additionalProperties": true
        },
        "scenarios": {
          "type": "array",
          "description": "Common clinical scenarios for this message",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "description": {"type": "string"},
              "populatedSegments": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        }
      }
    },
    "vendorNotes": {
      "type": "object",
      "description": "Vendor-specific implementation notes",
      "patternProperties": {
        "^[a-z]+$": {
          "type": "object",
          "properties": {
            "notes": {
              "type": "array",
              "items": {"type": "string"}
            },
            "commonSegments": {
              "type": "array",
              "description": "Segments this vendor commonly includes",
              "items": {"type": "string"}
            },
            "omittedSegments": {
              "type": "array",
              "description": "Segments this vendor commonly omits",
              "items": {"type": "string"}
            }
          }
        }
      }
    }
  },
  "definitions": {
    "messageElement": {
      "oneOf": [
        {"$ref": "#/definitions/segment"},
        {"$ref": "#/definitions/group"}
      ]
    },
    "segment": {
      "type": "object",
      "required": ["type", "segment", "usage", "cardinality"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["segment"]
        },
        "segment": {
          "type": "string",
          "description": "Segment code (MSH, PID, OBR, etc.)",
          "pattern": "^[A-Z]{2,3}$"
        },
        "name": {
          "type": "string",
          "description": "Human-readable segment name"
        },
        "usage": {
          "type": "string",
          "description": "Segment usage in this message: R=Required, O=Optional, C=Conditional, X=Not used",
          "enum": ["R", "O", "C", "X"]
        },
        "cardinality": {
          "type": "object",
          "description": "How many times this segment can appear",
          "required": ["min", "max"],
          "properties": {
            "min": {
              "type": "integer",
              "minimum": 0
            },
            "max": {
              "type": ["integer", "string"],
              "description": "Maximum occurrences (number or 'unbounded')"
            }
          }
        },
        "condition": {
          "type": "string",
          "description": "Condition for conditional usage (when usage='C')"
        },
        "notes": {
          "type": "array",
          "description": "Implementation notes for this segment in this message",
          "items": {"type": "string"}
        },
        "generationWeight": {
          "type": "number",
          "description": "Probability of including this optional segment (0.0-1.0)",
          "minimum": 0.0,
          "maximum": 1.0
        }
      }
    },
    "group": {
      "type": "object",
      "required": ["type", "name", "usage", "cardinality", "elements"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["group"]
        },
        "name": {
          "type": "string",
          "description": "Group name (e.g., 'ORDER', 'PATIENT', 'OBSERVATION')"
        },
        "usage": {
          "type": "string",
          "description": "Group usage: R=Required, O=Optional, C=Conditional",
          "enum": ["R", "O", "C"]
        },
        "cardinality": {
          "type": "object",
          "required": ["min", "max"],
          "properties": {
            "min": {
              "type": "integer",
              "minimum": 0
            },
            "max": {
              "type": ["integer", "string"]
            }
          }
        },
        "elements": {
          "type": "array",
          "description": "Segments/groups within this group",
          "items": {
            "$ref": "#/definitions/messageElement"
          }
        },
        "condition": {
          "type": "string",
          "description": "Condition for conditional usage"
        }
      }
    }
  }
}